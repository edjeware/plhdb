#!/bin/sh
# Copyright (C) 2016 The Meme Factory, Inc.  http://www.meme.com/
#
#    This file is part of PLHDB2.
#
#    PLHDB2 is free software; you can redistribute it and/or modify
#    it under the terms of the GNU General Public License as published by
#    the Free Software Foundation; either version 3 of the License, or
#    (at your option) any later version.
#
#    This program is distributed in the hope that it will be useful,
#    but WITHOUT ANY WARRANTY; without even the implied warranty of
#    MERCHANTABILITY or FITNESS FOR A PARTICULAR PURPOSE.  See the
#    GNU General Public License for more details.
#
#    You should have received a copy of the GNU General Public License
#    along with PLHDB2.  If not, see <http://www.gnu.org/licenses/>.
#
# Karl O. Pinc <kop@meme.com>
#
# Syntax: copy_demo olddemo fromdb todemodb
#
# Input:
#   olddemo The old demo db
#   fromdb  Database to copy from
#   todemodb    Database to copy into
#
# Remarks:
#   Copies into todemodb those rows in fromdb which are in the olddemo db.
#
# Support tables are either generated by hand or copied from the
# old demo database.  The biography and fertility rows
# are chosen from the old demo db but copied from the from db to the todemodb.

tmpfile=/tmp/copy_demo.$$

cleanup () {
  rm -rf $tmpfile
}

trap cleanup EXIT

demodb=$1
sourcedb=$2
targetdb=$3


{ m4 -D site_key=siteid -D taxon_key=taxonid -D study_key=sid convert.m4
  {
    # Biography and fertility
    psql -q --no-align -F ' ' --tuples-only -U plhdb_admin $demodb <<\EOF
    SELECT biography.studyid, biography.animid, biography.momid
      FROM biography
      ORDER BY biography.birthdate;
EOF
  } \
  | awk 'BEGIN {print "include(copy_both.m4)"; }
         {print "copy_both(" $1 ", " $2 ", " $3 ")";}' \
  | { m4 \
      ; cat - <<\EOF

    -- Update biography sequence.
    SELECT 'DO $$ BEGIN
              PERFORM SETVAL(''biography_bid_seq''
                          , MAX(biography.bid))
                FROM biography; END;$$;';

        -- Update femalefertiltyinterval sequence.
        SELECT 'DO $$ BEGIN
                  PERFORM SETVAL(''fertility_fid_seq''
                              , MAX(fertility.fid))
                    FROM fertility; END;$$;';
EOF
    }
  cat - <<\EOF
-- Give demo user plhdb-level select access in demo db
SELECT 'INSERT INTO permission (access, study, username)
          VALUES (''search'', ''all'', ''demo_user'');';
EOF
} \
  | psql -q --no-align -F ' ' --tuples-only -U plhdb_admin $sourcedb \
  | psql -q --tuples-only -U plhdb_admin $targetdb
